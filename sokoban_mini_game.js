/// <reference path=".config/sa.d.ts"/>

//---------------------------------------------------------
//--------------  MAPS  -----------------------------------
//---------------------------------------------------------

//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_00 = [ 1, 1, 2, 2, 2, 1, 1, 1, 1,   // 0
				 1, 1, 2, 4, 2, 1, 1, 1, 1,   // 1
				 1, 1, 2, 1, 2, 2, 2, 2, 1,   // 2
				 2, 2, 2, 3, 1, 3, 4, 2, 1,   // 3
				 2, 4, 1, 3, 6, 2, 2, 2, 1,   // 4
				 2, 2, 2, 2, 3, 2, 1, 1, 1,   // 5
				 1, 1, 1, 2, 4, 2, 1, 1, 1,   // 6
				 1, 1, 1, 2, 2, 2, 1, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_01 = [ 2, 2, 2, 2, 2, 1, 1, 1, 1,   // 0
				 2, 1, 1, 6, 2, 1, 1, 1, 1,   // 1
				 2, 1, 3, 3, 2, 1, 2, 2, 2,   // 2
				 2, 1, 3, 1, 2, 1, 2, 4, 2,   // 3
				 2, 2, 2, 1, 2, 2, 2, 4, 2,   // 4
				 1, 2, 2, 1, 1, 1, 1, 4, 2,   // 5
				 1, 2, 1, 1, 1, 2, 1, 1, 2,   // 6
				 1, 2, 1, 1, 1, 2, 2, 2, 2,   // 7
				 1, 2, 2, 2, 2, 2, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_02 = [ 1, 2, 2, 2, 2, 1, 1, 1, 1,   // 0
				 2, 2, 1, 1, 2, 1, 1, 1, 1,   // 1
				 2, 1, 6, 3, 2, 1, 1, 1, 1,   // 2
				 2, 2, 3, 1, 2, 2, 1, 1, 1,   // 3
				 2, 2, 1, 3, 1, 2, 1, 1, 1,   // 4
				 2, 4, 3, 1, 1, 2, 1, 1, 1,   // 5
				 2, 4, 4, 5, 4, 2, 1, 1, 1,   // 6
				 2, 2, 2, 2, 2, 2, 1, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_03 = [ 1, 2, 2, 2, 2, 1, 1, 1, 1,   // 0
				 1, 2, 6, 1, 2, 2, 2, 1, 1,   // 1
				 1, 2, 1, 3, 1, 1, 2, 1, 1,   // 2
				 2, 2, 2, 1, 2, 1, 2, 2, 1,   // 3
				 2, 4, 2, 1, 2, 1, 1, 2, 1,   // 4
				 2, 4, 3, 1, 1, 2, 1, 2, 1,   // 5
				 2, 4, 1, 1, 1, 3, 1, 2, 1,   // 6
				 2, 2, 2, 2, 2, 2, 2, 2, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_04 = [ 1, 1, 2, 2, 2, 2, 2, 2, 1,   // 0
				 1, 1, 2, 1, 1, 1, 1, 2, 1,   // 1
				 2, 2, 2, 3, 3, 3, 1, 2, 1,   // 2
				 2, 6, 1, 3, 4, 4, 1, 2, 1,   // 3
				 2, 1, 3, 4, 4, 4, 2, 2, 1,   // 4
				 2, 2, 2, 2, 1, 1, 2, 1, 1,   // 5
				 1, 1, 1, 2, 2, 2, 2, 1, 1,   // 6
				 1, 1, 1, 1, 1, 1, 1, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_05 = [ 1, 1, 2, 2, 2, 2, 2, 1, 1,   // 0
				 2, 2, 2, 1, 1, 6, 2, 1, 1,   // 1
				 2, 1, 1, 3, 4, 1, 2, 2, 1,   // 2
				 2, 1, 1, 4, 3, 4, 1, 2, 1,   // 3
				 2, 2, 2, 1, 5, 3, 1, 2, 1,   // 4
				 1, 1, 2, 1, 1, 1, 2, 2, 1,   // 5
				 1, 1, 2, 2, 2, 2, 2, 1, 1,   // 6
				 1, 1, 1, 1, 1, 1, 1, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_06 = [ 1, 1, 2, 2, 2, 2, 1, 1, 1,   // 0
				 1, 1, 2, 4, 4, 2, 1, 1, 1,   // 1
				 1, 2, 2, 1, 4, 2, 2, 1, 1,   // 2
				 1, 2, 1, 1, 3, 4, 2, 1, 1,   // 3
				 2, 2, 1, 3, 1, 1, 2, 2, 1,   // 4
				 2, 1, 1, 2, 3, 3, 1, 2, 1,   // 5
				 2, 1, 1, 6, 1, 1, 1, 2, 1,   // 6
				 2, 2, 2, 2, 2, 2, 2, 2, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_07 = [ 2, 2, 2, 2, 2, 2, 2, 2, 1,   // 0
				 2, 1, 1, 2, 1, 1, 1, 2, 1,   // 1
				 2, 1, 3, 4, 4, 3, 1, 2, 1,   // 2
				 2, 6, 3, 4, 5, 1, 2, 2, 1,   // 3
				 2, 1, 3, 4, 4, 3, 1, 2, 1,   // 4
				 2, 1, 1, 2, 1, 1, 1, 2, 1,   // 5
				 2, 2, 2, 2, 2, 2, 2, 2, 1,   // 6
				 1, 1, 1, 1, 1, 1, 1, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_08 = [ 2, 2, 2, 2, 2, 2, 1, 1, 1,   // 0
				 2, 1, 1, 1, 1, 2, 1, 1, 1,   // 1
				 2, 1, 3, 3, 3, 2, 2, 1, 1,   // 2
				 2, 1, 1, 2, 4, 4, 2, 2, 2,   // 3
				 2, 2, 1, 1, 4, 4, 3, 1, 2,   // 4
				 1, 2, 1, 6, 1, 1, 1, 1, 2,   // 5
				 1, 2, 2, 2, 2, 2, 2, 2, 2,   // 6
				 1, 1, 1, 1, 1, 1, 1, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_09 = [ 2, 2, 2, 2, 2, 2, 2, 1, 1,   // 0
				 2, 4, 4, 3, 4, 4, 2, 1, 1,   // 1
				 2, 4, 4, 2, 4, 4, 2, 1, 1,   // 2
				 2, 1, 3, 3, 3, 1, 2, 1, 1,   // 3
				 2, 1, 1, 3, 1, 1, 2, 1, 1,   // 4
				 2, 1, 3, 3, 3, 1, 2, 1, 1,   // 5
				 2, 1, 1, 2, 6, 1, 2, 1, 1,   // 6
				 2, 2, 2, 2, 2, 2, 2, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_10 = [ 1, 2, 2, 2, 2, 2, 1, 1, 1,   // 0
				 1, 2, 1, 6, 1, 2, 2, 2, 1,   // 1
				 2, 2, 1, 2, 3, 1, 1, 2, 1,   // 2
				 2, 1, 5, 4, 1, 4, 1, 2, 1,   // 3
				 2, 1, 1, 3, 3, 1, 2, 2, 1,   // 4
				 2, 2, 2, 1, 2, 4, 2, 1, 1,   // 5
				 1, 1, 2, 1, 1, 1, 2, 1, 1,   // 6
				 1, 1, 2, 2, 2, 2, 2, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_11 = [ 2, 2, 2, 2, 2, 2, 1, 1, 1,   // 0
				 2, 1, 1, 1, 1, 2, 1, 1, 1,   // 1
				 2, 1, 3, 1, 6, 2, 1, 1, 1,   // 2
				 2, 2, 5, 1, 1, 2, 1, 1, 1,   // 3
				 2, 1, 5, 1, 2, 2, 1, 1, 1,   // 4
				 2, 1, 5, 1, 2, 1, 1, 1, 1,   // 5
				 2, 1, 5, 1, 2, 1, 1, 1, 1,   // 6
				 2, 1, 4, 1, 2, 1, 1, 1, 1,   // 7
				 2, 2, 2, 2, 2, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_12 = [ 1, 1, 2, 2, 2, 2, 1, 1, 1,   // 0
				 1, 1, 2, 1, 1, 2, 1, 1, 1,   // 1
				 2, 2, 2, 3, 1, 2, 2, 1, 1,   // 2
				 2, 1, 1, 5, 1, 6, 2, 1, 1,   // 3
				 2, 1, 1, 5, 1, 1, 2, 1, 1,   // 4
				 2, 1, 1, 5, 1, 2, 2, 1, 1,   // 5
				 2, 2, 2, 5, 1, 2, 1, 1, 1,   // 6
				 1, 1, 2, 4, 2, 2, 1, 1, 1,   // 7
				 1, 1, 2, 2, 2, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_13 = [ 2, 2, 2, 2, 2, 1, 1, 1, 1,   // 0
				 2, 1, 1, 1, 2, 2, 2, 2, 2,   // 1
				 2, 1, 2, 1, 2, 1, 1, 1, 2,   // 2
				 2, 1, 3, 1, 1, 1, 3, 1, 2,   // 3
				 2, 4, 4, 2, 3, 2, 3, 2, 2,   // 4
				 2, 4, 6, 3, 1, 1, 1, 2, 1,   // 5
				 2, 4, 4, 1, 1, 2, 2, 2, 1,   // 6
				 2, 2, 2, 2, 2, 2, 1, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//-------------- 0  1  2  3  4  5  6  7  8  ------
var LEVEL_14 = [ 1, 2, 2, 2, 2, 2, 2, 1, 1,   // 0
				 1, 2, 1, 1, 1, 1, 2, 2, 1,   // 1
				 2, 2, 4, 2, 2, 3, 1, 2, 1,   // 2
				 2, 1, 4, 4, 3, 1, 1, 2, 1,   // 3
				 2, 1, 1, 2, 3, 1, 1, 2, 1,   // 4
				 2, 1, 1, 6, 1, 2, 2, 2, 1,   // 5
				 2, 2, 2, 2, 2, 2, 1, 1, 1,   // 6
				 1, 1, 1, 1, 1, 1, 1, 1, 1,   // 7
				 1, 1, 1, 1, 1, 1, 1, 1, 1 ]; // 8
				 
//------------------------------------------------------
//--------------  LEVELS  ------------------------------
//------------------------------------------------------

var ALL_LEVELS = [ LEVEL_00, LEVEL_01, LEVEL_02,   // --
				   LEVEL_03, LEVEL_04, LEVEL_05,   // --
				   LEVEL_06, LEVEL_07, LEVEL_08,   // --
				   LEVEL_09, LEVEL_10, LEVEL_11,   // --
				   LEVEL_12, LEVEL_13, LEVEL_14 ]; // --

//------------------------------------------------------
//--------------  CONSTANTS  ---------------------------
//------------------------------------------------------

const BLOCK_BACKGROUND 			= 1;
const BLOCK_WALL 				= 2;
const BLOCK_NORMAL_BOX 			= 3;
const BLOCK_POINT 				= 4;
const BLOCK_ACTIVE_BOX 			= 5;
const BLOCK_PLAYER_POSITION 	= 6;
	
const COLUMN_START_X 			= 38.0;
const ROW_START_Y    			= 38.0;
const BLOCK_SIZE     			= 32.0;
const ROWS_COUNT     			= 9;
const COLS_COUNT     			= 9;
const ROWS_COUNT_LIMIT  		= 8;
const COLS_COUNT_LIMIT  		= 8;

const DEFAULT_WAIT_TIME 		= 250;
const KEY_PRESSED_TIMEOUT 		= 150;
const REWARD_MONEY 				= 750;

const KEY_ACTIVATE_DEACTIVATE_1 = 187; // =
const KEY_ACTIVATE_DEACTIVATE_2 = 48;  // 0
const KEY_NEXT_LEVEL 			= 69;  // E
const KEY_PREV_LEVEL 			= 81;  // Q
const KEY_RELOAD_LEVEL 			= 82;  // R
const KEY_MOVE_TOP 				= 87;  // W
const KEY_MOVE_DOWN 			= 83;  // S
const KEY_MOVE_LEFT 			= 65;  // A
const KEY_MOVE_RIGHT 			= 68;  // D

//---------------------------------------------------------
//--------------  VARIABLES  ------------------------------
//---------------------------------------------------------

var CURRENT_LEVEL = new Array( ROWS_COUNT );
for( var i = 0; i < ROWS_COUNT; i++ )
	CURRENT_LEVEL[ i ] = new Array( COLS_COUNT );
	
var TOTAL_LEVELS = ALL_LEVELS.length;
var TOTAL_LEVELS_LIMIT = TOTAL_LEVELS - 1;
var FORCE_NEXT_LEVEL = false;
var IS_GAME_COMPLETE = false;

var CURRENT_LEVEL_INDEX = -1;
var PLAYER_POSITION = { 
	row: -1, column: -1, 
	resetNow: function() { this.row = -1; this.column = -1; },
	isValid: function() { return this.row > -1 && this.column > -1; }
};

var PLAYER_CHAR = new Player( 0 );
var PLAYER_ACTOR = PLAYER_CHAR.getChar();

//------------------------------------------------------
//--------------  FUNCTIONS  ---------------------------
//------------------------------------------------------

function playSound() { Sound.AddOneOffSound( 0.0, 0.0, 0.0, 1052 ); }

function loadLevel() { 
	PLAYER_POSITION.resetNow();
	for( var i = 0; i < ROWS_COUNT; i++ ) {
		for( var j = 0; j < COLS_COUNT; j++ ) {
			var blockIdInLevelArray = i * COLS_COUNT + j;
			CURRENT_LEVEL[ i ][ j ] = ALL_LEVELS[ CURRENT_LEVEL_INDEX ][ blockIdInLevelArray ];
			if( getBlockIdByIndexes( i, j ) === BLOCK_PLAYER_POSITION ) {
				savePlayerPosition( { row: i, column: j } );
				CURRENT_LEVEL[ i ][ j ] = BLOCK_BACKGROUND;
			}
		}
	}
	playSound();
	Text.PrintWith2NumbersNow( "PLA_10", CURRENT_LEVEL_INDEX + 1, TOTAL_LEVELS, 1000, 0 );
}

function unloadLevel() { CURRENT_LEVEL_INDEX -= 1; PLAYER_POSITION.resetNow(); } // CURRENT_LEVEL_INDEX = -1;

function loadPrevLevel() { CURRENT_LEVEL_INDEX -= 1; loadLevel(); }

function loadNextLevel() { CURRENT_LEVEL_INDEX += 1; loadLevel(); }

function isCanPlayGame() {
	if( !PLAYER_CHAR.isPlaying() )
		return false;
	if( !Char.DoesExist( PLAYER_ACTOR ) )
		return false;
	if( Char.IsDead( PLAYER_ACTOR ) || PLAYER_ACTOR.hasBeenArrested() || PLAYER_ACTOR.isInAnyCar() || !PLAYER_ACTOR.isStopped() )
		return false;
	if( PLAYER_ACTOR.getAreaVisible() !== 0 || Streaming.GetAreaVisible() !== 0 || Camera.GetFadingStatus() )
		return false;
	//if(  )
	//	return false;
	return !ONMISSION;
}

function setupPlayerInGameMode( isStartGame ) {
	Hud.Display( !isStartGame );
	Hud.DisplayRadar( !isStartGame );
	//if( PLAYER_CHAR.isPlaying() ) {
		Game.SetEveryoneIgnorePlayer( PLAYER_CHAR, isStartGame );
		PLAYER_CHAR.setIgnorePolice( isStartGame );
		PLAYER_CHAR.setControl( !isStartGame );
		PLAYER_ACTOR.setProofs( isStartGame, isStartGame, isStartGame, isStartGame, isStartGame );
	//}
	World.SetCarDensityMultiplier( isStartGame ? 0.0 : 1.0 );
	World.SetPedDensityMultiplier( isStartGame ? 0.0 : 1.0 );
	Text.UseCommands( isStartGame );
}

function isActivateGameKeysPressed() { return Pad.IsKeyPressed( KEY_ACTIVATE_DEACTIVATE_1 ) && Pad.IsKeyPressed( KEY_ACTIVATE_DEACTIVATE_2 ); }

function isPositionOutsideMap( position ) { return 0 > position.row || position.row > ROWS_COUNT_LIMIT || 0 > position.column || position.column > COLS_COUNT_LIMIT; }

function getNextPosition( position, direction ) { return { row: position.row + direction.row, column: position.column + direction.column }; }

function savePlayerPosition( position ) { PLAYER_POSITION.row = position.row; PLAYER_POSITION.column = position.column; }

function drawSprite( id, x, y ) { Hud.DrawSprite( id, x, y, BLOCK_SIZE, BLOCK_SIZE, 255, 255, 255, 255 ); }

function getBlockIdByIndexes( row, column ) { return CURRENT_LEVEL[ row ][ column ]; }

function getBlockIdByPosition( position ) { return getBlockIdByIndexes( position.row, position.column ); }

function getNextDirection() {
	if( Pad.IsKeyPressed( KEY_MOVE_TOP ) ) return { row: -1, column: 0 };
	if( Pad.IsKeyPressed( KEY_MOVE_DOWN ) ) return { row: 1, column: 0 };
	if( Pad.IsKeyPressed( KEY_MOVE_LEFT ) ) return { row: 0, column: -1 };
	if( Pad.IsKeyPressed( KEY_MOVE_RIGHT ) ) return { row: 0, column: 1 };
	return { row: 0, column: 0 };
}

function tryMoveBoxRelativePlayerDirection( position, direction, blockId ) {
	var nextPosition = getNextPosition( position, direction );
	if( isPositionOutsideMap( nextPosition ) )
		return false;
	var nextBlockId = getBlockIdByPosition( nextPosition );
	if( nextBlockId === BLOCK_WALL || nextBlockId === BLOCK_NORMAL_BOX || nextBlockId === BLOCK_ACTIVE_BOX )
		return false;
	CURRENT_LEVEL[ nextPosition.row ][ nextPosition.column ] = nextBlockId === BLOCK_POINT ? BLOCK_ACTIVE_BOX : BLOCK_NORMAL_BOX;
	CURRENT_LEVEL[ position.row ][ position.column ] = blockId === BLOCK_ACTIVE_BOX ? BLOCK_POINT : BLOCK_BACKGROUND;
	return true;
}

function isLevelComplete() {
	for( var i = 0; i < ROWS_COUNT; i++ ) {
		for( var j = 0; j < COLS_COUNT; j++ ) {
			if( getBlockIdByIndexes( i, j ) === BLOCK_POINT )
				return false;
		}
	}
	return true;
}

//------------------------------------------------------
//--------------  MAIN SCRIPT  -------------------------
//------------------------------------------------------

function script() {
	if( 1 > TOTAL_LEVELS )
		return;
	while( true ) {
		wait( DEFAULT_WAIT_TIME );
		if( !isCanPlayGame() )
			continue;
		do {
			wait( 0 );
			if( isActivateGameKeysPressed() ) {
				setupPlayerInGameMode( true );
				var position = PLAYER_ACTOR.getCoordinates(); 
				World.ClearArea( position.x, position.y, position.z, 35.0, true );
				Txd.LoadDictionary( "SOKOBAN" );
				Txd.LoadSprite( BLOCK_BACKGROUND, 	   "Background" );
				Txd.LoadSprite( BLOCK_WALL, 	  	   "Wall" 		);
				Txd.LoadSprite( BLOCK_NORMAL_BOX, 	   "NormalBox"	);
				Txd.LoadSprite( BLOCK_POINT, 	  	   "Point" 	 	);
				Txd.LoadSprite( BLOCK_ACTIVE_BOX, 	   "ActiveBox"  );
				Txd.LoadSprite( BLOCK_PLAYER_POSITION, "Player" 	);
				wait( DEFAULT_WAIT_TIME );
				IS_GAME_COMPLETE = false;
				FORCE_NEXT_LEVEL = false;
				Text.ClearHelp();
				beginGame();
				setupPlayerInGameMode( false );
				Txd.Remove();
				wait( DEFAULT_WAIT_TIME );
			}
		} while( isCanPlayGame() );
	}
}

function beginGame() {
	loadNextLevel();
	if( CURRENT_LEVEL_INDEX > -1 && PLAYER_POSITION.isValid() ) {
		TIMERA = 0;
		do {
			wait( 0 );
			if( !isCanPlayGame() )
				break;
			updateGame();
			if( 0 > CURRENT_LEVEL_INDEX || !PLAYER_POSITION.isValid() || IS_GAME_COMPLETE )
				break;
		} while( !isActivateGameKeysPressed() );
	}
	unloadLevel();
	playSound();
}

function updateGame() {	
	if( Pad.IsKeyPressed( KEY_RELOAD_LEVEL ) ) {
		loadLevel();
		wait( DEFAULT_WAIT_TIME );
		return;
	}	
	if( TOTAL_LEVELS > 1 ) {
		if( CURRENT_LEVEL_INDEX > 0 && Pad.IsKeyPressed( KEY_PREV_LEVEL ) ) {
			loadPrevLevel();
			wait( DEFAULT_WAIT_TIME );
			return;
		}	
		if( TOTAL_LEVELS_LIMIT > CURRENT_LEVEL_INDEX && ( FORCE_NEXT_LEVEL || Pad.IsKeyPressed( KEY_NEXT_LEVEL ) ) ) {
			FORCE_NEXT_LEVEL = false;
			loadNextLevel();
			wait( DEFAULT_WAIT_TIME );
			return;
		}
	}
	if( TIMERA > KEY_PRESSED_TIMEOUT )
		movingControl();
	drawMap();
}

function movingControl() {
	var direction = getNextDirection();
	if( direction.row === 0 && direction.column === 0 )
		return;
	TIMERA = 0;
	var nextPosition = getNextPosition( PLAYER_POSITION, direction );
	if( isPositionOutsideMap( nextPosition ) )
		return;
	var nextBlockId = getBlockIdByPosition( nextPosition );
	if( nextBlockId === BLOCK_BACKGROUND || nextBlockId === BLOCK_POINT ) {
		savePlayerPosition( nextPosition );
		return;
	}
	if( nextBlockId === BLOCK_WALL )
		return;
	if( !tryMoveBoxRelativePlayerDirection( nextPosition, direction, nextBlockId ) )
		return;
	savePlayerPosition( nextPosition );
	if( isLevelComplete() ) {
		FORCE_NEXT_LEVEL = true;
		if( CURRENT_LEVEL_INDEX === TOTAL_LEVELS_LIMIT ) {
			Audio.PlayMissionPassedTune( 1 );
			IS_GAME_COMPLETE = true
		}
		if( REWARD_MONEY > 0 )
			PLAYER_CHAR.addScore( ( CURRENT_LEVEL_INDEX + 1 ) * REWARD_MONEY );
	}
}

function drawMap() {
	Hud.DrawWindow( 14.0, 14.0, 320.0, 320.0, "DUMMY", 3 );
	var rowPosition = ROW_START_Y;
	var columnPosition = COLUMN_START_X;
	for( var i = 0; i < ROWS_COUNT; i++ ) {
		for( var j = 0; j < COLS_COUNT; j++ ) {
			var blockId = getBlockIdByIndexes( i, j );
			if( blockId === BLOCK_POINT || blockId === BLOCK_ACTIVE_BOX || blockId === BLOCK_NORMAL_BOX )  
				drawSprite( BLOCK_BACKGROUND, columnPosition, rowPosition );
			drawSprite( blockId, columnPosition, rowPosition );
			columnPosition += BLOCK_SIZE;
		}
		rowPosition += BLOCK_SIZE;
		columnPosition = COLUMN_START_X;
	}
	columnPosition = COLUMN_START_X + PLAYER_POSITION.column * BLOCK_SIZE;
	rowPosition = ROW_START_Y + PLAYER_POSITION.row * BLOCK_SIZE;
	drawSprite( BLOCK_PLAYER_POSITION, columnPosition, rowPosition );
}

//------------------------------------------------------
//--------------  RUN SCRIPT  --------------------------
//------------------------------------------------------

if( GAME === "sa" ) // || GAME === "sa_unreal"
	script();